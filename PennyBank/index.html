<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="../Images/Icon.png" type="image/png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">The Penny Bank</title>
  <style>
                .home-btn-wrapper {
                  display: flex;
                  align-items: flex-start;
                }
                @media (max-width: 600px) {
                  .home-btn-wrapper {
                    justify-content: center;
                  }
                  .home-btn {
                    margin-left: 0;
                    margin-right: 0;
                  }
                }
            @media (max-width: 600px) {
              .home-btn {
                display: block;
                margin: 2rem auto 0 auto;
                text-align: center;
              }
            }
        .home-btn {
          display: inline-block;
          margin: 0.5rem 0 0 0;
          background: #152a5a;
          color: #fff;
          border: 2px solid #2563eb;
          border-radius: 12px;
          padding: 1.2rem 2.5rem;
          font-size: 1.5rem;
          font-family: 'Segoe UI', sans-serif;
          font-weight: 700;
          text-align: center;
          text-decoration: none;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
          transition: all 0.15s ease;
          position: relative;
          overflow: hidden;
          cursor: pointer;
        }
        .home-btn:hover, .home-btn:focus {
          box-shadow: 0 0 25px rgba(243, 236, 64, 1);
          transform: scale(1.05);
          border-color: #f3ec40;
          background: #0b3797;
          color: #fff;
        }
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

    @font-face {
      font-family: 'Game Over';
      src: url('../Fonts/Game Over.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-size: 40rem
    }

    body {
      background-color: #000000;
      color: #e0e7ff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 2rem;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 12px;
    }
    
    ::-webkit-scrollbar-track {
      background: #000000;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #2563eb, #0b3797);
      border-radius: 6px;
      border: 2px solid #000000;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #0b3797, #2563eb);
    }
    
    /* Firefox scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: #2563eb #000000;
    }

    h1 {
      text-align: center;
      color: #f3ec40;
      font-family: 'Game Over', sans-serif;
      font-size: 12rem;
      margin-bottom: 2rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: opacity 0.15s ease;
      text-shadow: 
        -2px -2px 0 #1e3a8a,
        2px -2px 0 #1e3a8a,
        -2px 2px 0 #1e3a8a,
        2px 2px 0 #1e3a8a,
        -2px 0 0 #1e3a8a,
        2px 0 0 #1e3a8a,
        0 -2px 0 #1e3a8a,
        0 2px 0 #1e3a8a;
    }
    
    @media (max-width: 1200px) {
      h1 {
        font-size: 9rem;
      }
    }
    
    @media (max-width: 900px) {
      h1 {
        font-size: 6rem;
      }
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: 4rem;
        letter-spacing: 0.05em;
      }
    }
    
    h1.fade-out {
      opacity: 0;
    }

    .controls {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .penny-controls {
      display: inline-block;
    }

    select, input[type="text"] {
      padding: 0.75rem 1.25rem;
      font-size: 1.1rem;
      font-family: 'Segoe UI', sans-serif;
      border-radius: 12px;
      border: 2px solid #2563eb;
      background-color: #1e3a8a;
      color: #d1d9ff;
      cursor: pointer;
      margin: 0.5rem;
      transition: border-color 0.15s ease;
      width: 200px;
      box-sizing: border-box;
    }
    
    select:hover, input[type="text"]:hover {
      border-color: #f3ec40;
    }
    
    
/* --- Leaderboard --- */

    .leaderboard {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 1rem;
      padding: 0;
      max-width: 3840px;
      margin: 0 auto;
    }

    @media (min-width: 600px) {
      .leaderboard {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 900px) {
      .leaderboard {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1200px) {
      .leaderboard {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 1800px) {
      .leaderboard {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (min-width: 2200px) {
      .leaderboard {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    .entry {
  background: #152a5a;
  border-radius: 12px;
  padding: 0.75rem 1rem;
  font-size: 1.2rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
  overflow: hidden;
  white-space: nowrap;
  cursor: pointer;
  border: 2px solid #2563eb;
  transition: all 0.15s ease;
}

    .entry .name {
  flex: 1 1 auto;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: bold;
  font-size: 1.5rem;
  min-width: 0;
}

    .value {
      font-weight: bold;
      font-size: 2rem;
    }

    .entry:hover {
      box-shadow: 0 0 25px rgba(243, 236, 64, 1);
      transform: scale(1.05);
      border-color: #f3ec40;
      border-radius: 16px;
      background: #0b3797;
    }

    .ordinal {
      color: #f3ec40;
      font-weight: bold;
      margin-right: 1rem;
      font-size: 2rem;
      text-shadow: 1px 2px 3px rgba(0, 0, 0, 0.7);
    }

    .gold {
      background-color: #FFFFC5;
      color: #000;
      border: 2px solid #ffd700;
      box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
    }
    
    .gold:hover {
      box-shadow: 0 0 25px rgba(255, 215, 0, 1);
      transform: scale(1.05);
      border-color: #ffd700;
      border-radius: 16px;
      background: #FFFFDD;
    }

    .silver {
      background-color: #FFFFFF;
      color: #000;
      border: 2px solid #C0C0C0;
      box-shadow: 0 4px 10px rgba(192, 192, 192, 0.3);
    }
    
    .silver:hover {
      box-shadow: 0 0 30px rgba(192, 192, 192, 1);
      transform: scale(1.05);
      border-color: #DDDDDD;
      border-radius: 16px;
      background: #F5F5F5;
    }

    .bronze {
      background-color: #FFC78F;
      color: #000;
      border: 2px solid #CD7F32;
      box-shadow: 0 4px 10px rgba(205, 127, 50, 0.3);
    }
    
    .bronze:hover {
      box-shadow: 0 0 30px rgba(205, 127, 50, 1);
      transform: scale(1.05);
      border-color: #CD7F32;
      border-radius: 16px;
      background: #FFD7A7;
    }

    .gold .ordinal {
      color: #ffd700;
      font-size: 3rem;
    }

    .silver .ordinal {
      color: #DDDDDD;
      font-size: 3rem;
    }

    .bronze .ordinal {
      color: #CD7F32;
      font-size: 3rem;
    }
    
    
    
/* --- Medal Cabinets --- */

#medalBoard {
  display: grid;
  grid-template-columns: repeat(1, 1fr);
  gap: 1rem;
  padding: 0;
  max-width: 3840px;
  margin: 0 auto;
}

@media (min-width: 600px) {
  #medalBoard {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 900px) {
  #medalBoard {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1200px) {
  #medalBoard {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (min-width: 1800px) {
  #medalBoard {
    grid-template-columns: repeat(4, 1fr);
  }
}

@media (min-width: 2200px) {
  #medalBoard {
    grid-template-columns: repeat(5, 1fr);
  }
}

.medal-column.total {
  background: none;
  padding: 0;
  border-radius: 0;
}
.medal-column.total h2 {
  text-align: center;
  color: #f3ec40;
  font-family: 'Orbitron', sans-serif;
  font-size: 2rem;
  margin-bottom: 1rem;
}



/* Unified grid layout for medallists */
.medal-grid {

  display: grid;
  grid-template-columns: 1fr;
  gap: 1rem;
}

/* Reuse entry card styling from Penny Bank */
.medallist {
  background: #152a5a;
  border-radius: 12px;
  padding: 0.75rem 1rem;
  font-size: 1.2rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: space-between;
  align-items: center;
  white-space: nowrap;
  gap: 0.5rem;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid #2563eb;
  transition: all 0.15s ease;
}


.medallist:hover {
  box-shadow: 0 0 25px rgba(243, 236, 64, 1);
  transform: scale(1.05);
  border-color: #f3ec40;
  border-radius: 16px;
  background: #0b3797;
}

.medallist > span:nth-child(1) {
  flex: 0 0 auto;
  font-size: 2rem;
  color: #f3ec40;
  font-weight: bold;
  margin-right: 1rem;
  text-shadow: 1px 2px 3px rgba(0, 0, 0, 0.7);
}

.medallist > span:nth-child(2) {
  flex: 1 1 auto;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-weight: bold;
  font-size: 1.5rem;
  min-width: 0;
}

.medallist > span:nth-child(3) {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: flex-end;
  text-align: right;
  min-width: 6em;
  max-width: 12em;
}

.medallist > span:nth-child(3) .total-count {
  font-weight: 700;
  font-size: 1.2em;
  color: #fff;
  white-space: nowrap;
}

.medallist > span:nth-child(3) small {
  font-size: 0.9em;
  color: #ddd;
  display: block;
  margin-top: 0.25rem;
  line-height: 1.8;
  text-align: right;
}

.medal-badge {
  display: inline-block;
  padding: 0.1rem 0.35rem;
  margin: 0.1rem 0.15rem;
  border-radius: 4px;
  font-weight: bold;
  font-size: 0.8em;
  white-space: nowrap;
}

.medal-gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
.medal-silver { background: linear-gradient(135deg, #C0C0C0, #808080); color: #000; }
.medal-bronze { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }
.medal-lobby { background: linear-gradient(135deg, #6b8e23, #556b2f); color: #fff; }


#returnButton {
  appearance: none;
  padding: 0.4em 0.6em;
}

.hidden {
  display: none !important;
}

#loadingScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #000000;
  color: #f3ec40;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 8vw;
  z-index: 1000;
  font-family: 'Game Over', sans-serif;
  letter-spacing: 0.05em;
  text-shadow: 0 0 20px rgba(243, 236, 64, 0.8), 0 0 40px rgba(243, 236, 64, 0.5);
  animation: pulse 1s ease-in-out infinite;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.6s ease-out, visibility 0s linear 0.6s;
  padding: 1rem;
  text-align: center;
  pointer-events: none;
  box-sizing: border-box;
}

#loadingScreen strong {
  max-width: 100%;
  word-wrap: break-word;
}

#loadingScreen.show {
  visibility: visible;
  opacity: 1;
  pointer-events: all;
  transition: opacity 0.3s ease-in, visibility 0s linear;
}

@keyframes pulse {
  0%, 100% { 
    text-shadow: 0 0 20px rgba(243, 236, 64, 0.6), 0 0 40px rgba(243, 236, 64, 0.3);
  }
  50% { 
    text-shadow: 0 0 20px rgba(243, 236, 64, 1), 0 0 40px rgba(243, 236, 64, 0.7);
  }
}

  </style>
</head>
<body>
  <div class="home-btn-wrapper">
    <a href="../index.html" class="home-btn">Home</a>
  </div>
<div id="loadingScreen"><strong id="loadingText">
  LOADING MEDAL CABINET...</strong>
</div>
  <h1 id="mainTitle">The Penny Bank</h1>
  <div class="controls">
    
  <div class="penny-controls" id="pennyControls" style="display: inline-block;">
    <select id="modeSelect">
      <option value="credits">Author Credits</option>
      <option value="current" selected>Current Season</option>
      <option value="total">All-Time</option>
    </select>
  </div>
  
  <select id="formatSelect" style="width: 300px;">
    <option value="leaderboard">The Penny Bank</option>
  </select>
  
  <div class="penny-controls" id="searchControls" style="display: inline-block;">
    <input type="text" id="searchInput" placeholder="Filter Players...">
  </div>
  
</div>
  <div id="leaderboard" class="leaderboard fade"></div>
  
  <p id="noPlayersMessage" class="hidden" style="text-align:center; color: firebrick; font-size: 2.5rem; margin-top: 2rem;">
  <strong>NO PLAYERS FOUND</strong>
</p>
  
  <div id="medalBoard" class="medal-board fade" style="display: none;"></div>

  <script>
    const DATA_URL = 'https://raw.githubusercontent.com/persephoneschair/PennyStorage/main/NewPennys.txt';
    const FORMATS = ['Abyss.txt', 'Battlefront.txt', 'BiddingWar.txt', 'Crossfire.txt', 'Cryptex.txt', 'DangerZone.txt', 'DataLeak.txt', 'DEFCON.txt', 'Distinction.txt', 'EscapeArtist.txt', 'GoogleThat.txt', 'Hive.txt', 'HiveLeaderboard.txt', 'Mole.txt', 'MoleLeaderboard.txt', 'Moneybox.txt', 'MoneyboxLeaderboard.txt', 'Purge.txt', 'Pyramid.txt', 'RedHerrings.txt', 'RiskyBusiness.txt', 'Spotlight.txt', 'SpotlightLeaderboard.txt']; // Update with real format file names
    const FORMAT_LABELS = {
      "Abyss.txt": "The Abyss",
      "Battlefront.txt": "Battlefront",
      "BiddingWar.txt": "Bidding War",
      "Crossfire.txt": "Crossfire",
      "Cryptex.txt": "Cryptex",
      "DangerZone.txt": "DangerZone",
      "DataLeak.txt": "Data Leak",
      "DEFCON.txt": "DEFCON",
      "Distinction.txt": "Distinction!",
      "EscapeArtist.txt": "The Escape Artist",
      "GoogleThat.txt": "Google That!",
      "Hive.txt": "The Hive",
      "HiveLeaderboard.txt": "The Hive Leaderboard",
      "Mole.txt": "The Mole",
      "MoleLeaderboard.txt": "The Mole Leaderboard",
      "Moneybox.txt": "Moneybox",
      "MoneyboxLeaderboard.txt": "Moneybox Leaderboard",
      "Purge.txt": "The Purge",
      "Pyramid.txt": "The Pyramid",
      "RedHerrings.txt": "Red Herrings!",
      "RiskyBusiness.txt": "Risky Business",
      "Spotlight.txt": "Spotlight",
      "SpotlightLeaderboard.txt": "Spotlight Leaderboard"
    };

    let players = [];    

    function setLoadingMessage(message) {
      const loadingText = document.getElementById('loadingText');
      if (loadingText) {
        loadingText.textContent = message;
      }
    }

    async function fetchData() {
      try {
        const response = await fetch(DATA_URL);
        const data = await response.json();
        players = data.playerList.map(p => ({
          name: p.PlayerName,
          credits: p.AuthorCredits,
          current: p.CurrentSeasonPennys,
          total: p.AllTimePennys
        }));
        renderLeaderboard();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function renderLeaderboard() {
    
      const medalBoard = document.getElementById('medalBoard');
      const leaderboard = document.getElementById('leaderboard');
      const mainTitle = document.getElementById('mainTitle');
      
      medalBoard.style.display = 'none';
      medalBoard.classList.add('hidden');
      leaderboard.style.display = 'grid';
      leaderboard.classList.remove('hidden');
      mainTitle.textContent = 'The Penny Bank';
      mainTitle.style.visibility = 'visible';
      mainTitle.style.opacity = '1';
      document.title = 'The Penny Bank';

      const mode = document.getElementById('modeSelect').value;
      const search = document.getElementById('searchInput').value.toLowerCase();
      const board = document.getElementById('leaderboard');
      const noPlayersMsg = document.getElementById('noPlayersMessage');
      noPlayersMsg.style.visibility = 'visible';
      board.innerHTML = '';

      const filtered = players
        .filter(p => p[mode] && parseFloat(p[mode]) > 0)
        .sort((a, b) => parseFloat(b[mode]) - parseFloat(a[mode]));

      let matchCount = 0;
      let displayIndex = 0;
      filtered.forEach((player, index) => {
        if (!player.name.toLowerCase().includes(search)) return;
        matchCount++;

        const div = document.createElement('div');
        div.className = 'entry';
        if (displayIndex === 0) div.classList.add('gold');
        else if (displayIndex === 1) div.classList.add('silver');
        else if (displayIndex === 2) div.classList.add('bronze');

        div.innerHTML = `
          <span class="ordinal">${displayIndex + 1}</span>
          <span class="name" title="${player.name}">${player.name}</span>
          <span class="value">${Number(player[mode]).toLocaleString()}</span>
        `;
        board.appendChild(div);
        displayIndex++;
        
      });
      
      // Show/hide no results message
      if (matchCount === 0) {
        noPlayersMsg.classList.remove('hidden');
        board.style.display = 'none';
      } else {
        noPlayersMsg.classList.add('hidden');
        board.style.display = 'grid';
      }
    }
    
    function renderFormatLeaderboard(data, label) {
  const board = document.getElementById('medalBoard');
  const leaderboard = document.getElementById('leaderboard');
  const pennyControls = document.getElementById('pennyControls');
  const noPlayersMsg = document.getElementById('noPlayersMessage');
  const mainTitle = document.getElementById('mainTitle');

  // Hide leaderboard immediately
  leaderboard.style.display = 'none';
  leaderboard.classList.add('hidden');
  
  // Build content off-screen first
  const fragment = document.createDocumentFragment();
  const sorted = [...data].sort((a, b) => b.playerScore - a.playerScore);

  sorted.forEach((entry, index) => {
    const row = document.createElement('div');
    row.className = 'entry';
    if (index === 0) row.classList.add('gold');
    else if (index === 1) row.classList.add('silver');
    else if (index === 2) row.classList.add('bronze');
    row.innerHTML = `
      <span class="ordinal">${index + 1}</span>
      <span class="name" title="${entry.playerName}">${entry.playerName}</span>
      <span class="value">${entry.playerScore.toLocaleString()}</span>
    `;
    fragment.appendChild(row);
  });
  
  // Update board with all content at once
  board.innerHTML = '';
  board.appendChild(fragment);
  board.style.display = 'grid';
  board.style.visibility = 'visible';
  board.style.opacity = '1';
  board.classList.remove('hidden');
  mainTitle.textContent = `${label}`;
  mainTitle.style.visibility = 'visible';
  mainTitle.style.opacity = '1';
  document.title = label;
  pennyControls.style.display = 'none';
  document.getElementById('searchControls').style.display = 'none';
  noPlayersMsg.style.visibility = 'visible';
  noPlayersMsg.classList.add('hidden');

  // Attach handlers after rows exist
  attachPlayerClickHandlers();
}

  function renderMedalBoard(data, label) {
  const leaderboard = document.getElementById('leaderboard');
  const board = document.getElementById('medalBoard');
  const noPlayersMsg = document.getElementById('noPlayersMessage');
  const mainTitle = document.getElementById('mainTitle');
  
  leaderboard.style.display = 'none';
  leaderboard.classList.add('hidden');
  board.innerHTML = '';
  board.style.display = 'grid';
  board.style.visibility = 'visible';
  board.style.opacity = '1';
  board.classList.remove('hidden');
  mainTitle.textContent = `${label} Medal Cabinet`;
  mainTitle.style.visibility = 'visible';
  mainTitle.style.opacity = '1';
  document.title = `${label} Medal Cabinet`;
  pennyControls.style.display = 'none';
  document.getElementById('searchControls').style.display = 'none';
  noPlayersMsg.style.visibility = 'visible';
  noPlayersMsg.classList.add('hidden');

  const types = ['gold', 'silver', 'bronze', 'lobby'];
  const medalCounts = {};

  types.forEach(type => {
    const list = data[type + 'Medallists'] || [];
    list.forEach(name => {
      if (!medalCounts[name]) medalCounts[name] = { gold: 0, silver: 0, bronze: 0, lobby: 0 };
      medalCounts[name][type]++;
    });
  });

  const players = Object.entries(medalCounts).map(([name, counts]) => ({
    name,
    gold: counts.gold || 0,
    silver: counts.silver || 0,
    bronze: counts.bronze || 0,
    lobby: counts.lobby || 0,
    total: (counts.gold || 0) + (counts.silver || 0) + (counts.bronze || 0) + (counts.lobby || 0)
  }));

  players.sort((a, b) => {
    if (b.gold !== a.gold) return b.gold - a.gold;
    if (b.silver !== a.silver) return b.silver - a.silver;
    if (b.bronze !== a.bronze) return b.bronze - a.bronze;
    if (b.lobby !== a.lobby) return b.lobby - a.lobby;
    return b.total - a.total;
  });

  function getOrdinalLabels(list) {
    let labels = [];
    let currentRank = 1;
    for (let i = 0; i < list.length; i++) {
      const cur = list[i];
      const prev = i > 0 ? list[i - 1] : null;
      if (
        prev &&
        cur.gold === prev.gold &&
        cur.silver === prev.silver &&
        cur.bronze === prev.bronze &&
        cur.lobby === prev.lobby &&
        cur.total === prev.total
      ) {
        labels.push(`=${currentRank}`);
      } else {
        currentRank = i + 1;
        const next = i < list.length - 1 ? list[i + 1] : null;
        if (
          next &&
          cur.gold === next.gold &&
          cur.silver === next.silver &&
          cur.bronze === next.bronze &&
          cur.lobby === next.lobby &&
          cur.total === next.total
        ) {
          labels.push(`=${currentRank}`);
        } else {
          labels.push(`${currentRank}`);
        }
      }
    }
    return labels;
  }

  const ordinals = getOrdinalLabels(players);

  players.forEach((player, index) => {
    const breakdown = `
      ${player.gold ? `<span class="medal-badge medal-gold">ü•á ${player.gold}</span>` : ''}
      ${player.silver ? `<span class="medal-badge medal-silver">ü•à ${player.silver}</span>` : ''}
      ${player.bronze ? `<span class="medal-badge medal-bronze">ü•â ${player.bronze}</span>` : ''}
      ${player.lobby ? `<span class="medal-badge medal-lobby">üéñÔ∏è ${player.lobby}</span>` : ''}
    `.trim();

    const row = document.createElement('div');
    row.className = 'medallist';
    row.innerHTML = `
      <span class="ordinal-medal">${ordinals[index]}</span>
      <span title="${player.name}">${player.name}</span>
      <span>
        <span class="total-count">üèÜ ${player.total}</span>
        <small>${breakdown}</small>
      </span>
    `;

    // Add click handler to load player's medal cabinet
    row.style.cursor = 'pointer';
    row.onclick = () => {
      setLoadingMessage(`LOADING ${player.name.toUpperCase()}'S MEDAL CABINET`);
      renderPlayerCabinet(player.name);
    };

    board.appendChild(row);
  });
}

function getChunkSize() {
  const width = window.innerWidth;
  if (width < 600) return 1;
  if (width < 900) return 2;
  if (width < 1200) return 3;
  if (width < 1800) return 4;
  return 5;
}

// ------------------
// 1. Render Player Cabinet
async function renderPlayerCabinet(playerName) {
  // Quick check if player exists first (before showing loading screen)
  try {
    const resp = await fetch(DATA_URL);
    const allData = await resp.json();
    const playerObj = allData.playerList.find(p => p.PlayerName === playerName);
    
    // If player not found, silently do nothing
    if (!playerObj) {
      return;
    }
  } catch (error) {
    // Silently fail - do nothing
    console.error('Error checking player:', error);
    return;
  }
  
  const loadingScreen = document.getElementById('loadingScreen');
  const board = document.getElementById('medalBoard');
  const leaderboard = document.getElementById('leaderboard');
  const pennyControls = document.getElementById('pennyControls');
  const formatSelect = document.getElementById('formatSelect');

  // Hide the title immediately (before any scrolling)
  const mainTitle = document.getElementById('mainTitle');
  mainTitle.style.visibility = 'hidden';
  
  // Show loading screen immediately
  loadingScreen.classList.add('show');
  
  // Scroll to top immediately
  window.scrollTo(0, 0);
  
  // Hide old content immediately
  leaderboard.classList.add('hidden');
  leaderboard.style.display = 'none';
  
  // Keep board hidden while we build it
  board.style.display = 'none';
  board.classList.add('hidden');
  board.innerHTML = '';
  
  // Hide format dropdown and controls
  formatSelect.style.display = 'none';
  pennyControls.style.display = 'none';
  document.getElementById('searchControls').style.display = 'none';
  
  // Start timer and fetch data in parallel
  const startTime = Date.now();
  
  // Small delay to ensure loading screen is visible
  await new Promise(resolve => setTimeout(resolve, 100));

  try {
    // Load data again (we know player exists now)
    const resp = await fetch(DATA_URL);
    const allData = await resp.json();
    const playerObj = allData.playerList.find(p => p.PlayerName === playerName);
  
  // Build all content in a document fragment (not visible yet)
  const fragment = document.createDocumentFragment();
  
  // Render Penny counts as leaderboard-style rows
  const statMap = [
    { label: 'Current Season Pennys', key: 'CurrentSeasonPennys' },
    { label: 'All-Time Pennys', key: 'AllTimePennys' },
    { label: 'Author Credits', key: 'AuthorCredits' }
  ];

  statMap.forEach(({ label, key }) => {
    const val = playerObj[key];
    if (val > 0) {
      const row = document.createElement('div');
      row.className = 'entry gold stat-row';
      row.innerHTML = `
        <span class="name">${label}</span>
        <span class="value">${Number(val).toLocaleString()}</span>
      `;
      fragment.appendChild(row);
    }
  });

  // Loop through each format and tally medals
  for (const fmt of FORMATS) {
    const res = await fetch(`https://raw.githubusercontent.com/persephoneschair/PennyStorage/main/${fmt}`);
    const data = await res.json();
    const types = ['gold', 'silver', 'bronze', 'lobby'];
    const counts = { gold: 0, silver: 0, bronze: 0, lobby: 0 };

    types.forEach(type => {
      (data[type + 'Medallists'] || []).forEach(name => {
        if (name === playerName) counts[type]++;
      });
    });

    const total = Object.values(counts).reduce((a, b) => a + b, 0);
    if (total === 0) continue;

    const breakdown = `
      ${counts.gold ? `<span class="medal-badge medal-gold">ü•á ${counts.gold}</span>` : ''}
      ${counts.silver ? `<span class="medal-badge medal-silver">ü•à ${counts.silver}</span>` : ''}
      ${counts.bronze ? `<span class="medal-badge medal-bronze">ü•â ${counts.bronze}</span>` : ''}
      ${counts.lobby ? `<span class="medal-badge medal-lobby">üéñÔ∏è ${counts.lobby}</span>` : ''}
    `.trim();

    const row = document.createElement('div');
    row.className = 'medallist';
    row.innerHTML = `
      <span></span>
      <span class="name">${FORMAT_LABELS[fmt] || fmt.replace('.txt', '')}</span>
      <span>
        <span class="total-count">üèÜ ${total}</span>
        <small>${breakdown}</small>
      </span>
    `;
    fragment.appendChild(row);
  }
  
  // Ensure minimum 800ms display time
  const elapsed = Date.now() - startTime;
  if (elapsed < 800) {
    await new Promise(resolve => setTimeout(resolve, 800 - elapsed));
  }

  // Add all the pre-built content at once (while still hidden)
  board.appendChild(fragment);
  
  // Small delay to ensure content is fully rendered
  await new Promise(resolve => setTimeout(resolve, 100));
  
  // Start fading out the loading screen first
  loadingScreen.classList.remove('show');
  
  // Small delay before showing board (so loading screen opacity starts fading)
  await new Promise(resolve => setTimeout(resolve, 100));
  
  // Only add the back button if it doesn't already exist (do this now while fading)
  let backBtn = document.getElementById('returnButton');
  if (!backBtn) {
    backBtn = document.createElement('button');
    backBtn.id = 'returnButton';
    backBtn.textContent = 'Back';

    // Use the regular entry class (like a standard strap)
    backBtn.className = 'entry';
    backBtn.style.width = '100%';
    backBtn.style.justifyContent = 'center';
    backBtn.style.fontSize = '1.5rem';
    backBtn.style.fontWeight = 'bold';
    backBtn.style.padding = '0.75rem 1.25rem';
    backBtn.style.marginBottom = '1rem';
    backBtn.style.color = '#e0e7ff';
    backBtn.style.pointerEvents = 'auto';
    
    // Override hover to prevent transform/scale
    backBtn.style.setProperty('transform', 'none', 'important');

    backBtn.onclick = () => {
      // Hide everything with opacity IMMEDIATELY (instant, no layout recalc)
      const loadingScreen = document.getElementById('loadingScreen');
      const mainTitle = document.getElementById('mainTitle');
      const medalBoard = document.getElementById('medalBoard');
      
      // Hide title with visibility IMMEDIATELY to prevent flash during scroll
      mainTitle.style.visibility = 'hidden';
      
      // Hide everything with opacity FIRST, before any scrolling
      medalBoard.style.opacity = '0';
      mainTitle.style.opacity = '0';
      backBtn.style.opacity = '0';
      
      // Show loading screen immediately
      loadingScreen.classList.add('show');
      
      // Scroll to top immediately
      window.scrollTo(0, 0);
      
      // Small delay to ensure loading screen is visible, then trigger change
      setTimeout(() => {
        backBtn.remove();
        formatSelect.style.display = 'inline-block';
        pennyControls.style.display = 'inline-block';
        document.getElementById('searchControls').style.display = 'inline-block';
        formatSelect.value = 'leaderboard';
        formatSelect.dispatchEvent(new Event('change'));
      }, 50);
    };

    formatSelect.parentNode.insertBefore(backBtn, formatSelect);
  }
  
  // Update title and show the board as loading screen fades
  mainTitle.textContent = `${playerName}'s Medal Cabinet`;
  document.title = `${playerName}'s Medal Cabinet`;
  mainTitle.style.visibility = 'visible';
  mainTitle.style.opacity = '1';
  board.style.visibility = 'visible';
  board.style.opacity = '1';
  board.style.display = 'grid';
  board.classList.remove('hidden');
  
  } catch (error) {
    // If anything goes wrong during rendering, clean up and hide loading screen
    console.error('Error loading player cabinet:', error);
    loadingScreen.classList.remove('show');
    formatSelect.style.display = 'inline-block';
    pennyControls.style.display = 'inline-block';
    mainTitle.style.visibility = 'visible';
    renderLeaderboard();
  }
}

// ------------------
// 2. Bind click handlers
function attachPlayerClickHandlers() {
  document.querySelectorAll('.entry, .medallist').forEach(el => {
    const name = el.querySelector('.name')?.textContent;
    if (name) {
      el.style.cursor = 'pointer';
      el.onclick = () => {
        setLoadingMessage(`LOADING ${name.toUpperCase()}'S MEDAL CABINET`);
        renderPlayerCabinet(name);
      };
    }
  });
}

// ------------------
// 3. Wrap fadeSwitch (if not already defined)
async function fadeSwitch(fromEl, toEl, callback) {
  fromEl.classList.add('hidden');
  await new Promise(res => setTimeout(res, 400));
  fromEl.style.display = 'none';
  toEl.style.display = 'grid';
  void toEl.offsetWidth;
  toEl.classList.remove('hidden');
  if (callback) callback();
}

// ------------------
// 4. Ensure handlers reattach on render
const originalLeaderboard = renderLeaderboard;
renderLeaderboard = function() {
  originalLeaderboard();
  attachPlayerClickHandlers();
};

const originalMedalBoard = renderMedalBoard;
renderMedalBoard = function(data, label) {
  originalMedalBoard(data, label);
  attachPlayerClickHandlers();
};

const originalFormatLeaderboard = renderFormatLeaderboard;
renderFormatLeaderboard = function(data, label) {
  originalFormatLeaderboard(data, label);
  attachPlayerClickHandlers();
};

// Initialize
document.getElementById('pennyControls').style.display = 'inline-block';


    document.getElementById('modeSelect').addEventListener('change', renderLeaderboard);
    document.getElementById('searchInput').addEventListener('input', renderLeaderboard);
   document.getElementById('formatSelect').addEventListener('change', async function () {
  const val = this.value;
  const loadingScreen = document.getElementById('loadingScreen');
  const mainTitle = document.getElementById('mainTitle');
  const pennyControls = document.getElementById('pennyControls');
  const formatSelect = document.getElementById('formatSelect');
  const medalBoard = document.getElementById('medalBoard');
  
  // Determine what we're loading and set message accordingly
  if (val === 'leaderboard') {
    setLoadingMessage('LOADING THE PENNY BANK');
  } else {
    const formatLabel = FORMAT_LABELS[val] || val;
    // Check if it's a leaderboard format
    if (val.includes('Leaderboard')) {
      setLoadingMessage(`LOADING ${formatLabel.toUpperCase()}`);
    } else {
      setLoadingMessage(`LOADING ${formatLabel.toUpperCase()} MEDAL CABINET`);
    }
  }
  const startTime = Date.now();

  // Hide everything immediately with opacity to prevent jump
  medalBoard.style.opacity = '0';
  mainTitle.style.opacity = '0';
  pennyControls.style.visibility = 'hidden';
  document.getElementById('searchControls').style.visibility = 'hidden';
  document.getElementById('noPlayersMessage').style.visibility = 'hidden';
  formatSelect.style.visibility = 'hidden';
  loadingScreen.classList.add('show');
  window.scrollTo(0, 0);
  
  // Small delay to ensure loading screen is visible
  await new Promise(resolve => setTimeout(resolve, 100));

  if (val === 'leaderboard') {
    pennyControls.style.display = 'inline-block';
    document.getElementById('searchControls').style.display = 'inline-block';
    
    // Ensure minimum 800ms display time
    const elapsed = Date.now() - startTime;
    if (elapsed < 800) {
      await new Promise(resolve => setTimeout(resolve, 800 - elapsed));
    }
    
    renderLeaderboard();
    
    // Small delay before hiding loading screen
    await new Promise(resolve => setTimeout(resolve, 100));
    loadingScreen.classList.remove('show');
    await new Promise(resolve => setTimeout(resolve, 100));
    mainTitle.style.visibility = 'visible';
    pennyControls.style.visibility = 'visible';
    pennyControls.style.opacity = '1';
    document.getElementById('searchControls').style.visibility = 'visible';
    document.getElementById('searchControls').style.opacity = '1';
    formatSelect.style.visibility = 'visible';
    return;
  }

  pennyControls.style.opacity = '0';

  try {
    const response = await fetch(`https://raw.githubusercontent.com/persephoneschair/PennyStorage/main/${val}`);
    const data = await response.json();
    
    // Ensure minimum 800ms display time
    const elapsed = Date.now() - startTime;
    if (elapsed < 800) {
      await new Promise(resolve => setTimeout(resolve, 800 - elapsed));
    }

    if (val.endsWith('Leaderboard.txt')) {
      renderFormatLeaderboard(data, FORMAT_LABELS[val] || val.replace('.txt', ''));
    } else {
      renderMedalBoard(data, FORMAT_LABELS[val] || val.replace('.txt', ''));
    }
    
    // Small delay before hiding loading screen
    await new Promise(resolve => setTimeout(resolve, 100));
    loadingScreen.classList.remove('show');
    await new Promise(resolve => setTimeout(resolve, 100));
    mainTitle.style.visibility = 'visible';
    formatSelect.style.visibility = 'visible';
  } catch (err) {
    console.error('Error loading view:', err);
    loadingScreen.classList.remove('show');
    mainTitle.style.visibility = 'visible';
    formatSelect.style.visibility = 'visible';
  }
});

    FORMATS.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = FORMAT_LABELS[name] || name.replace('.txt', '');
      document.getElementById('formatSelect').appendChild(opt);
    });

    fetchData();
  </script>
</body>
</html>
